#!/usr/bin/perl
BEGIN {
        unshift @INC,'./lib';
        unshift @INC,'/home/websites/lib';
        unshift @INC,'/usr/local/homeAutomation/lib';
}
use strict;
use POSIX; 
use JSON;
use LWP::Simple;
use URI::Escape;
use Cattech::HomeAutomation;

$::HA=Cattech::HomeAutomation->new();

my $log = "/etc/heyu/x10_events.log";

my $date = strftime("%Y-%m-%d %H:%M:%S", localtime(time));

#my $helper = $ENV{helper};

#my ($address,$action) = $helper=~m/([a-z0-9]*)([A-Z].*)/;

my $data={};

my $mode='url';
if ($ENV{X10_Source} ne "") {
	$data->{source}="X10";
	$data->{unit}=$ENV{X10_Unit};
	$data->{house}=$ENV{X10_Housecode};
	$data->{action}=$ENV{X10_Function};
	$data->{x10_Source}=$ENV{X10_Source};
}else{
	if ($ARGV[0]=~m/([a-p])([1-9]|0[1-9]|1[0-6])(On|Off|Dim|Bri)/) {
		$data->{source}="X10";
		$data->{unit}=$1;
		$data->{house}=$2;
		$data->{action}=$3;
		$data->{x10_Source}='args';
	}else{
		foreach my $e (keys %ENV) {
			$data->{$e} = $ENV{$e};
		}
		$data->{source}="HEYU_OTHER_TRIGGER";
		$data->{_ARGS}=join(",",@ARGV);
		$data->{_PARENT}=getppid();
		$mode='log';
	}
}

#if ($mode eq 'log') {
	my $json = JSON->new->utf8->canonical->encode($data);
	if ( open(my $LOG,">>",$log) ) {
		print $LOG $json."\n";
		close $LOG;
	}else{
		print "Couldn't write to $log : $!\n";
	}	
#}
#if ($mode eq 'url') {
	$::HA->sendDataToHub("eventHandler",$data);
#	my $url = "http://pawz.cattech.org/pw/homeAutomation/eventHandler.cgi?event=".uri_escape($json);
#	my $content = get $url;
#}

my $example = <<EOB;
2017-06-14 00:45:30 b9On 
X10_Source=SNDC
X10_Housecode=B
X10_Unit=9
X10_LastUnit=9
bighelper=b9On 
helper=b9On 
X10_Function=On
X10_function=on

X10_Counter3=0
X10_TzFlag8=1
X10_N13=1024
X10_F15=1024
isClear=32768
X10_TzFlag4=1
X10_CzFlag17=1
X10_K5=1024
X10_TzFlag14=1
X10_N9=1024
X10_I1=1024
X10_CzFlag7=1
isLoBat=1
X10_M2=1024
X10_WeekDayName=Wed
X10_G10=1024
isMain=16
X10_A5=1024
X10_CzFlag22=1
X10_Hour=0
LANG=en_US.UTF-8
X10_Timer19=0
X10_L7=1024
X10_F2=1024
X10_Counter22=0
isTamper=64
X10_D8=1024
X10_TzFlag30=1
isHeat=16384
X10_N16=1024
X10_K7=1024
X10_TzFlag9=1
X10_CzFlag6=1
X10_M15=1024
X10_P5=1024
X10_A2=1024
isAuxClear=131072
X10_M1=1024
X10_CzFlag26=1
X10_Timer31=0
X10_Timer18=0
X10_N14=1024
X10_CzFlag9=1
PWD=/
X10_O8=1024
X10_J14=1024
X10_Counter10=0
X10_GMT=1497419130
X10_K16=1024
X10_Linmap=256
X10_N10=1024
X10_CzFlag30=1
X10_Timer10=0
X10_I10=1024
X10_A15=1024
X10_D15=1024
X10_K15=1024
X10_I14=1024
X10_P2=4194404
X10_Day=14
X10_K1=1024
X10_H4=1024
X10_Timer25=0
X10_K13=1024
X10_A7=1024
X10_J8=1024
isInit=32768
X10_J2=1024
X10_CzFlag25=1
X10_L2=1024
X10_L9=1024
X10_Timer8=0
isRHmax=1024
X10_Timer30=0
X10_K11=1024
X10_E9=1024
X10_A6=1024
X10_A13=1024
X10_E1=1024
X10_Counter29=0
X10_M7=1024
X10_P16=1024
X10_K10=1024
X10_TzFlag13=1
X10_Counter28=0
X10_Timer23=0
X10_N2=1024
isActive=524288
X10_CzFlag8=1
X10_WeekDay=3
X10_A8=1024
X10_M3=1024
X10_M4=1024
X10_Timer11=0
X10_O11=1024
X10_SecLights=0
X10_C11=1024
X10_CzFlag4=1
X10_H9=1024
X10_C15=1024
X10_E3=1024
X10_C9=1024
X10_CzFlag32=1
isOn=4194304
X10_J9=1024
X10_H7=1024
X10_Timer26=0
X10_Flag20=0
X10_C8=1024
isBPmin=2048
X10_Flag23=0
X10_Flag25=0
X10_I4=1024
X10_G13=1024
X10_H5=1024
X10_Flag18=0
X10_TzFlag10=1
X10_Counter19=0
isSet=8192
X10_E2=1024
X10_Timer22=0
isSwMax=8
X10_B5=1024
X10_Flag22=0
X10_O16=1024
X10_E5=1024
X10_Vident=0
isDim=8192
X10_Counter5=0
X10_D6=1024
X10_Timer4=0
X10_Counter20=0
X10_C3=1024
X10_F7=1024
isRollover=2
X10_D13=1024
X10_G4=1024
isAuxAlert=262144
X10_L4=1024
X10_A11=1024
X10_J3=1024
X10_F1=1024
X10_G16=1024
X10_TzFlag6=1
X10_O2=1024
X10_Flag3=0
X10_Counter16=0
X10_CzFlag11=1
X10_TzFlag25=1
X10_Timestamp=1497419130
HEYU_VERSION=2.11-rc2
X10_O14=1024
X10_F3=1024
X10_I12=1024
X10_TzFlag27=1
X10_A16=1024
X10_CzFlag5=1
X10_TzFlag22=1
isBPmax=4096
X10_O5=1024
isSdusk=262144
X10_Counter24=0
X10_CzFlag16=1
X10_B2=1024
X10_H14=1024
X10_Counter11=0
X10_ArmPendingTimer=0
X10_Counter30=0
X10_Timer16=0
X10_I7=1024
X10_G8=1024
HEYU_PARENT=ENGINE
X10_MonthName=Jun
X10_B11=4194404
X10_F14=1024
X10_Counter21=0
X10_Counter2=0
X10_Counter25=0
X10_P14=1024
X10_TzFlag32=1
X10_O7=1024
X10_J15=1024
X10_I9=1024
X10_N1=1024
X10_N3=1024
X10_Flag1=0
X10_I15=1024
X10_CzFlag19=1
X10_Timer21=0
X10_F4=1024
IAMHEYU=1
X10_I6=1024
X10_P4=1024
X10_Timer28=0
X10_L3=1024
X10_O10=1024
X10_CzFlag1=1
X10_TzFlag15=1
X10_E4=1024
X10_B13=1024
X10_isDST=1
X10_Timer5=0
X10_Flag13=0
X10_Timer15=0
X10_Timer12=0
X10_Counter15=0
X10_Flag29=0
X10CONFIG=/usr/local/etc/heyu/x10.conf
X10_CzFlag15=1
X10_G15=1024
X10_G1=3072
X10_Timer13=0
X10_A14=1024
X10_Timer29=0
X10_L13=1024
X10_Counter13=0
X10_TzFlag17=1
isAddr=2048
X10_M5=1024
X10_Flag5=0
X10_J12=1024
X10_G5=1024
X10_CzFlag14=1
X10_P3=1024
X10_K8=1024
X10_B9=4212836
X10_F13=1024
X10_TzFlag2=1
X10_G3=1024
X10_DateString=2017/06/14 00:45:30
X10_N12=1024
X10_M13=1024
X10_Flag6=0
X10_C10=1024
X10_Timer1=0
X10_Timer9=0
X10_N6=1024
X10_N8=1024
X10_O6=1024
X10_I13=1024
X10_G6=1024
X10_N11=1024
X10_Counter31=0
X10_Timer2=0
X10_D2=1024
X10_Timer32=0
isAppl=256
X10_I11=1024
X10_J10=1024
X10_L12=1024
X10_Counter27=0
X10_B16=1024
X10_H11=1024
X10_Timer17=0
X10_B7=1024
X10_TzFlag31=1
X10_C1=1024
X10_CzFlag21=1
X10_D5=1024
X10_B6=1024
X10_Second=30
X10_CzFlag18=1
X10_D10=1024
X10_D7=1024
X10_M8=1024
X10_Flag8=0
X10_A9=1024
X10_J4=1024
X10_A1=1024
X10_CzFlag20=1
X10_Counter12=0
X10_UnitAlias=_no_alias_
X10_TzFlag23=1
X10_B10=4194404
X10_Flag31=0
X10_O3=1024
X10_I5=1024
X10_J1=1024
X10_D3=1024
X10_C7=4194404
X10_M12=1024
X10_I16=1024
X10_TzFlag12=1
X10_Away=0
isAux=32
isSdawn=131072
X10_H6=1024
X10_Flag21=0
X10_E12=1024
X10_CzFlag2=1
X10_J5=1024
X10_M6=1024
X10_TzFlag24=1
X10_Flag12=0
isOff=1024
X10_E11=1024
X10_Flag14=0
X10_Flag32=0
X10_TzFlag29=1
X10_L6=1024
X10_J13=1024
X10_C6=1024
isChg=4096
X10_Home=0
X10_A12=1024
X10_E16=1024
X10_F9=1024
X10_E7=1024
X10_CzFlag12=1
X10_J11=1024
X10_TzFlag20=1
X10_G2=1024
X10_M10=1024
X10_L10=1024
X10_H1=1024
X10_Timer20=0
X10_Flag26=0
X10_F16=1024
X10_TzFlag5=1
X10_M16=1024
X10_H13=1024
X10_K4=1024
X10_Year=2017
X10_E13=1024
X10_TzFlag18=1
X10_Counter26=0
X10_D12=1024
X10_CzFlag24=1
X10_H8=1024
X10_J6=1024
HEYU_RELEASE_DATE=20150320
X10_H3=1024
X10_P11=1024
X10_P6=1024
X10_Flag28=0
X10_Timer14=0
X10_P15=1024
X10_Counter18=0
X10_G9=1024
X10_K3=1024
X10_Timer27=0
X10_Timer6=0
X10_B4=1024
X10_Flag11=0
X10_CzFlag10=1
X10_C12=1024
X10_P8=1024
X10_L11=1024
X10_Tamper=0
X10_Flag10=0
X10_Flag16=0
X10_Flag9=0
X10_F8=1024
X10_TzFlag28=1
X10_Counter14=0
X10_I2=1024
X10_E6=1024
X10_J16=1024
X10_Month=6
X10_TzFlag7=1
isRHmin=512
X10_D1=1024
X10_Flag2=0
X10_F10=1024
isSpend=512
X10_F5=1024
X10_D11=1024
X10_M9=1024
X10_N15=1024
X10_D9=1024
X10_TzFlag19=1
X10_N7=1024
X10_Counter6=0
isTmax=256
X10_Counter23=0
X10_O4=1024
X10_TzFlag21=1
X10_B12=1024
X10_L14=1024
X10_Counter32=0
X10_TzFlag3=1
X10_A4=1024
PATH=/bin:/usr/bin:/sbin:/usr/sbin:/usr/local/bin
X10_Timer7=0
X10_Flag30=0
X10_C4=4194404
X10_A3=1024
X10_K2=1024
X10_P1=4196452
X10_CzFlag27=1
X10_Counter17=0
X10_I8=1024
X10_D4=1024
X10_Minute=45
X10_E14=1024
X10_Counter1=0
X10_Counter4=0
X10_J7=1024
X10_E10=1024
X10_O9=1024
X10_N4=1024
X10_H15=1024
X10_B14=1024
X10_Flag17=0
X10_E8=1024
X10_TzFlag26=1
X10_A10=1024
X10_Counter8=0
X10_Flag7=0
isInactive=1048576
X10_CzFlag28=1
X10_Disarmed=1
X10_Expire=-3
whatLevel=255
X10_F11=1024
X10_H2=1024
X10_M14=1024
X10_G14=1024
X10_K6=1024
X10_O15=1024
X10_L1=1024
X10_L16=1024
X10_C16=1024
X10_L8=1024
X10_Timer24=0
X10_O1=1024
X10_F12=1024
X10_Flag27=0
X10_E15=1024
isValid=16384
X10_P7=1024
X10_C13=1024
X10_B3=1024
X10_TzFlag11=1
X10_C14=1024
X10_Armed=0
X10_B8=1024
isTmin=128
X10_P9=1024
X10_TzFlag1=1
X10_H16=1024
X10_O13=1024
X10_Counter7=0
X10_C5=2104320
X10_CzFlag13=1
X10_F6=1024
X10_SysTime=2730
isSwMin=4
X10_D16=1024
X10_H10=1024
X10_D14=1024
isAlert=65536
X10_CzFlag23=1
X10_G11=1024
X10_CzFlag29=1
X10_H12=1024
X10_P13=1024
X10_P12=1024
X10_O12=1024
X10_Flag19=0
X10_M11=1024
X10_G7=1024
X10_P10=4194404
X10_L15=1024
X10_Flag4=0
X10_Flag24=0
X10_B1=1024
X10_N5=1024
X10_Timer3=0
X10_G12=1024
X10_TzFlag16=1
X10_C2=1024
X10_CzFlag3=1
X10_I3=1024
X10_B15=1024
X10_Counter9=0
X10_ArmPending=0
X10_L5=1024
X10_K12=1024
X10_K9=1024
X10_CzFlag31=1
X10_K14=1024
X10_Flag15=0

EOB
